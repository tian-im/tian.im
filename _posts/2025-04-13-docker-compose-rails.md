---
title: Docker-compose Rails
layout: post
tags:
  - programming
---

* Initialize repo.

  ```shell
  git init
  ```

* Add `docker-compose.yml`.

   ```yml
  services:
    builder:
      image: ruby:3.4
      volumes:
        - .:/app
      working_dir: /app
      environment:
        - BUNDLE_PATH=/usr/local/bundle
        - RAILS_ENV=development
      # Replace my_app
      command: bash -c "gem install rails -v 8.0.2 && rails new . -n my_app --database=postgresql --skip-bundle --force"
   ```

* Run the builder.

  ```shell
  docker-compose run builder
  ```

* There should be a `Dockerfile` generated by Rails.
* Remove the `builder` section and add services `web` and `db`.

  ```yml
  services:
    web:
      build: .
      command: bash -c "rm -f tmp/pids/server.pid && rails server -b 0.0.0.0"
      environment:
        - HISTFILE=.bash_history
        # Replace my_app_
        - DATABASE_URL=postgres://postgres:password@db:5432/my_app_${RAILS_ENV:-development}
        - RAILS_ENV=${RAILS_ENV:-development}
      volumes:
        - .:/app
        - bundle_cache:/usr/local/bundle
        - node_modules:/app/node_modules
      ports:
        - "3000:3000"
      depends_on:
        - db
      stdin_open: true
      tty: true

    db:
      image: postgres:16
      environment:
        POSTGRES_PASSWORD: password
        POSTGRES_USER: postgres
        # Replace my_app_
        POSTGRES_DB: my_app_${RAILS_ENV:-development}
      volumes:
        - postgres_data:/var/lib/postgresql/data
      ports:
        - "5432:5432"

  volumes:
    postgres_data:
    bundle_cache:
    node_modules:
  ```

* Spin up the services.

  ```shell
  docker-compose up
  ```
